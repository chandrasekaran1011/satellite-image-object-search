<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Satellite Image Object Search</title>

    <!-- Bootstrap 5 CSS -->
    <link
      href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css"
      rel="stylesheet"
    />

    <!-- Vue 3 Global Build -->
    <script src="https://unpkg.com/vue@3/dist/vue.global.prod.js"></script>

    <style>
      /* General body styling */
      body {
        padding-top: 70px;
        background-color: #f8f9fa;
      }

      /* Container for image + canvas overlay */
      .canvas-container {
        position: relative;
        display: inline-block;
        max-width: 100%;
      }

      /* Canvas positioned on top of image */
      canvas {
        position: absolute;
        top: 0;
        left: 0;
        pointer-events: none;
      }

      img {
        max-width: 100%;
        height: auto;
        display: block;
        border-radius: 8px;
      }

      /* Loader spinner */
      .spinner-container {
        text-align: center;
        margin-top: 20px;
      }

      /* Detected objects container */
      .results-container {
        margin-top: 20px;
      }

      /* Styling for each detection item in the list */
      .detection-item {
        padding: 10px;
        border-bottom: 1px solid #ddd;
        cursor: pointer;
        transition: background-color 0.2s ease, transform 0.2s ease;
      }
      .detection-item:hover {
        background-color: #e9ecef;
        transform: translateX(4px);
      }
      .detection-item.active {
        background-color: #007bff;
        color: white;
        transform: translateX(4px);
      }

      /* Grouping detections by class */
      .class-group {
        margin-bottom: 1rem;
      }

      /* Confidence badge */
      .badge {
        font-weight: normal;
      }
    </style>
  </head>

  <body>
    <!-- Navbar -->
    <nav class="navbar navbar-expand-lg navbar-dark bg-primary fixed-top">
      <div class="container-fluid">
        <a class="navbar-brand" href="#">Object Detection in Satellite Images</a>
      </div>
    </nav>

    <!-- Vue App Container -->
    <div id="app" class="container my-4">
      <!-- Form: Image upload + model selection + detect button -->
      <form @submit.prevent="submitImage" class="mb-4">
        <div class="row g-3 align-items-center">
          <!-- Image file input -->
          <div class="col-md-6">
            <input
              type="file"
              class="form-control"
              @change="onFileChange"
              accept="image/*" 
              required
            />
          </div>

          <!-- Model selection dropdown -->
          <div class="col-md-4">
            <select class="form-select" v-model="selectedModel" required>
              <option disabled value="">Select Model</option>
              <option value="custom">Custom Trained YOLO Model</option>
              <option value="yolo">Pre-trained YOLO Model</option>
            </select>
          </div>

          <!-- Detect button -->
          <div class="col-md-2 d-grid">
            <button
              type="submit"
              :disabled="!file || !selectedModel" 
              class="btn btn-primary"
            >
              Detect
            </button>
          </div>
        </div>
      </form>

      <!-- Loading spinner -->
      <div v-if="loading" class="spinner-container">
        <div class="spinner-border text-primary" role="status">
          <span class="visually-hidden">Loading...</span>
        </div>
      </div>

      <!-- Results Section -->
      <div v-if="imageUrl && !loading" class="results-container row">
        <!-- Left: Image + Canvas -->
        <div class="col-md-8">
          <div class="card">
            <div class="card-header bg-primary text-white">Image</div>
            <div class="card-body">
              <div class="text-center">
                <div class="canvas-container">
                  <!-- Uploaded image -->
                  <img
                    :src="imageUrl"
                    ref="image"
                    class="img-fluid"
                    @load="drawBoxes" 
                  />
                  <!-- Canvas overlay for bounding boxes -->
                  <canvas ref="canvas"></canvas>
                </div>
              </div>
            </div>
          </div>
        </div>

        <!-- Right: Detected objects list -->
        <div class="col-md-4">
          <div class="card">
            <div class="card-header bg-primary text-white">Detected Objects</div>
            <div class="card-body" style="max-height: 600px; overflow-y: auto">
              <!-- No objects detected message -->
              <div v-if="groupedDetections.length === 0" class="text-muted">
                No objects detected.
              </div>

              <!-- List of detections grouped by class -->
              <div v-else>
                <div
                  v-for="group in groupedDetections"
                  :key="group.class_name"
                  class="class-group"
                >
                  <h6>{{ capitalize(group.class_name) }}</h6>
                  <div
                    v-for="det in group.items"
                    :key="det.number"
                    :class="[
                      'detection-item',
                      { active: highlightedDetection && highlightedDetection.number === det.number }
                    ]"
                    @click="highlightDetection(det)" 
                  >
                    <div class="d-flex justify-content-between align-items-center">
                      <div>{{ det.number }}. {{ capitalize(det.class_name) }}</div>
                      <span
                        class="badge"
                        :class="det.confidence >= 0.8 ? 'bg-success' : 'bg-warning text-dark'"
                      >
                        {{ Math.round(det.confidence * 100) }}%
                      </span>
                    </div>
                  </div>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>

    <script>
      Vue.createApp({
        data() {
          return {
            file: null, // Uploaded file
            imageUrl: "", // URL for displaying uploaded image
            selectedModel: "custom", // Model selection
            detections: [], // Array of detection objects from server
            loading: false, // Loading spinner toggle
            classColors: {}, // Map of class_name -> color for bounding boxes
            highlightedDetection: null, // Currently selected detection
          };
        },
        computed: {
          // Group detections by class_name for UI display
          groupedDetections() {
            const groups = {};
            this.detections.forEach((det) => {
              if (!groups[det.class_name]) {
                groups[det.class_name] = {
                  class_name: det.class_name,
                  items: [],
                };
              }
              groups[det.class_name].items.push(det);
            });
            return Object.values(groups);
          },
        },
        methods: {
          // Capitalize first letter of each word
          capitalize(text) {
            if (!text) return "";
            return text
              .split(" ")
              .map((word) => word.charAt(0).toUpperCase() + word.slice(1))
              .join(" ");
          },

          // Handle file selection & validate type
          onFileChange(event) {
            const selectedFile = event.target.files[0];
            if (!selectedFile) return;

            if (!selectedFile.type.startsWith("image/")) {
              alert("Please upload a valid image file.");
              this.file = null;
              this.imageUrl = "";
              return;
            }

            this.file = selectedFile;
            this.imageUrl = URL.createObjectURL(this.file);
            this.detections = [];
            this.classColors = {};
          },

          // Submit image to backend for detection
          submitImage() {
            if (!this.file || !this.selectedModel) return;

            this.loading = true;
            this.detections = [];
            this.classColors = {};
            this.highlightedDetection = null;

            let formData = new FormData();
            formData.append("image", this.file);
            formData.append("model_name", this.selectedModel);

            fetch("/detect", {
              method: "POST",
              body: formData,
            })
              .then((response) => response.json())
              .then((data) => {
                // Add serial numbers to each detection
                let counter = 1;
                data.detections.forEach((det) => {
                  det.number = counter++;
                });
                this.detections = data.detections || [];
                this.loading = false;
                this.$nextTick(() => this.drawBoxes()); // Draw boxes after DOM update
              })
              .catch((err) => {
                console.error("Error:", err);
                this.loading = false;
              });
          },

          // Generate or retrieve color for each class
          getColorForClass(class_name) {
            if (!this.classColors[class_name]) {
              const r = 20 + Math.floor(Math.random() * 60);
              const g = 20 + Math.floor(Math.random() * 60);
              const b = 20 + Math.floor(Math.random() * 60);
              this.classColors[class_name] = `rgb(${r},${g},${b})`;
            }
            return this.classColors[class_name];
          },

          // Highlight a detection when clicked
          highlightDetection(det) {
            this.highlightedDetection = det;
            this.drawBoxes();
          },

          // Draw bounding boxes and badges on canvas
          drawBoxes() {
            const img = this.$refs.image;
            const canvas = this.$refs.canvas;
            canvas.width = img.width;
            canvas.height = img.height;

            const ctx = canvas.getContext("2d");
            ctx.clearRect(0, 0, canvas.width, canvas.height);
            ctx.lineWidth = 2;
            ctx.font = "14px Arial";
            ctx.textBaseline = "middle";
            ctx.textAlign = "center";

            this.detections.forEach((det) => {
              const [x_min, y_min, x_max, y_max] = det.bounding_box;
              const scaleX = img.width / img.naturalWidth;
              const scaleY = img.height / img.naturalHeight;

              const rectX = x_min * scaleX;
              const rectY = y_min * scaleY;
              const rectWidth = (x_max - x_min) * scaleX;
              const rectHeight = (y_max - y_min) * scaleY;

              const color = this.getColorForClass(det.class_name);

              // Draw bounding box
              ctx.strokeStyle = color;
              ctx.lineWidth = 4;
              ctx.shadowBlur =
                this.highlightedDetection &&
                this.highlightedDetection.number === det.number
                  ? 10
                  : 0;
              ctx.shadowColor =
                this.highlightedDetection &&
                this.highlightedDetection.number === det.number
                  ? color
                  : "transparent";
              ctx.strokeRect(rectX, rectY, rectWidth, rectHeight);

              // Draw circular badge with serial number
              const badgeRadius = 12;
              const badgeX = rectX + 15;
              const badgeY = rectY + 15;

              ctx.beginPath();
              ctx.arc(badgeX, badgeY, badgeRadius, 0, 2 * Math.PI);
              ctx.fillStyle = color;
              ctx.fill();

              ctx.fillStyle = "white";
              ctx.fillText(det.number, badgeX, badgeY);
            });
          },
        },
      }).mount("#app");
    </script>
  </body>
</html>
